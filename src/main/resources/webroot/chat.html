<!doctype html>
<html>
    <head>
        <title>VChat</title>
        <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
        <script src="Js/vertx-eventbus.js"></script>
        <script src="Js/chatBox.js"></script>
        <link href="Css/chatBox.css" rel="stylesheet"/>

        <script type="text/javascript">
            var eb = new EventBus("/clientController/");
            eb.onopen = function () {
                console.log("Event bus is open");
//                getUserInfo();
                fetchFriendList("Sachin");
                eb.registerHandler("chat.to.client", function (err, msg) {
                    var parsedData = msg.body;
                    if(parsedData.classifier=="getUserInfo"){
                        localStorage.setItem("userName",parsedData.screenName);
                        localStorage.setItem("name",parsedData.name);
                        $("#userInfo").text("Welcome "+parsedData.name);
                        fetchFriendList(parsedData.screenName)
                    }
                    else if(parsedData.classifier=="fetchFriendList"){
                        showFriendList(parsedData)
                    }
                    else if(parsedData.classifier=="fetchMessage"){
                        var friendId = parsedData.friendId;
                        var message = parsedData.message;
                        showMessage(friendId,message);
                    }

                    return false;
                });
            };

            function getUserInfo() {
                console.log("Sending Message");
                var tokenKey = localStorage.getItem("tokenKey");
                var tokenKeySecret = localStorage.getItem("tokenKeySecret");
                var verifier = localStorage.getItem("verifier");
                eb.publish("chat.to.server", {classifier:"getUserInfo",tokenKey:tokenKey,
                    tokenKeySecret:tokenKeySecret,verifier:verifier});
            }

            function fetchFriendList(userName){
                eb.publish("chat.to.server", {classifier:"fetchFriendList",whom:userName});
            }


            function showFriendList(friends){
                for(var name in friends){
                    var mainDiv = $(".chat-sidebar");
                    if(name!="classifier"){
                        var value = friends[name];
                        var innerDiv = $("<div class='sidebar-name' id='"+name+"-sidebar'>");
                        var aTag = $('<a id="popUpOpener-'+name+'"></a>');
                        aTag.attr("href",'javascript:register_popup("'+name+'","'+value+'")');
                        aTag.append('<img width="30" height="30" src="Sachin_Aryal.jpg" />');
                        aTag.append('<span id="displayName">'+value+'</span>');
                        innerDiv.append(aTag);
                        innerDiv.append('</div>');
                        mainDiv.append(innerDiv);
                    }
                }
            }

        </script>

    </head>
    <body>
    <div id="currentUser">
        <h1 id="userInfo"></h1>
    </div>
        <div class="chat-sidebar">

        </div>
        
    </body>
</html>
